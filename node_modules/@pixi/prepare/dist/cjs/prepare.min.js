/*!
 * @pixi/prepare - v6.4.2
 * Compiled Thu, 02 Jun 2022 15:39:26 UTC
 *
 * @pixi/prepare is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@pixi/settings"),e=require("@pixi/core"),i=require("@pixi/graphics"),r=require("@pixi/ticker"),o=require("@pixi/display"),n=require("@pixi/text");t.settings.UPLOADS_PER_FRAME=4;var s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},s(t,e)};var u=function(){function t(t){this.maxItemsPerFrame=t,this.itemsLeft=0}return t.prototype.beginFrame=function(){this.itemsLeft=this.maxItemsPerFrame},t.prototype.allowedToUpload=function(){return this.itemsLeft-- >0},t}();function a(t,i){var r=!1;if(t&&t._textures&&t._textures.length)for(var o=0;o<t._textures.length;o++)if(t._textures[o]instanceof e.Texture){var n=t._textures[o].baseTexture;-1===i.indexOf(n)&&(i.push(n),r=!0)}return r}function h(t,i){if(t.baseTexture instanceof e.BaseTexture){var r=t.baseTexture;return-1===i.indexOf(r)&&i.push(r),!0}return!1}function p(t,i){if(t._texture&&t._texture instanceof e.Texture){var r=t._texture.baseTexture;return-1===i.indexOf(r)&&i.push(r),!0}return!1}function c(t,e){return e instanceof n.Text&&(e.updateText(!0),!0)}function l(t,e){if(e instanceof n.TextStyle){var i=e.toFontString();return n.TextMetrics.measureFont(i),!0}return!1}function f(t,e){if(t instanceof n.Text){-1===e.indexOf(t.style)&&e.push(t.style),-1===e.indexOf(t)&&e.push(t);var i=t._texture.baseTexture;return-1===e.indexOf(i)&&e.push(i),!0}return!1}function d(t,e){return t instanceof n.TextStyle&&(-1===e.indexOf(t)&&e.push(t),!0)}var x=function(){function e(e){var i=this;this.limiter=new u(t.settings.UPLOADS_PER_FRAME),this.renderer=e,this.uploadHookHelper=null,this.queue=[],this.addHooks=[],this.uploadHooks=[],this.completes=[],this.ticking=!1,this.delayedTick=function(){i.queue&&i.prepareItems()},this.registerFindHook(f),this.registerFindHook(d),this.registerFindHook(a),this.registerFindHook(h),this.registerFindHook(p),this.registerUploadHook(c),this.registerUploadHook(l)}return e.prototype.upload=function(t,e){"function"==typeof t&&(e=t,t=null),t&&this.add(t),this.queue.length?(e&&this.completes.push(e),this.ticking||(this.ticking=!0,r.Ticker.system.addOnce(this.tick,this,r.UPDATE_PRIORITY.UTILITY))):e&&e()},e.prototype.tick=function(){setTimeout(this.delayedTick,0)},e.prototype.prepareItems=function(){for(this.limiter.beginFrame();this.queue.length&&this.limiter.allowedToUpload();){var t=this.queue[0],e=!1;if(t&&!t._destroyed)for(var i=0,o=this.uploadHooks.length;i<o;i++)if(this.uploadHooks[i](this.uploadHookHelper,t)){this.queue.shift(),e=!0;break}e||this.queue.shift()}if(this.queue.length)r.Ticker.system.addOnce(this.tick,this,r.UPDATE_PRIORITY.UTILITY);else{this.ticking=!1;var n=this.completes.slice(0);this.completes.length=0;for(i=0,o=n.length;i<o;i++)n[i]()}},e.prototype.registerFindHook=function(t){return t&&this.addHooks.push(t),this},e.prototype.registerUploadHook=function(t){return t&&this.uploadHooks.push(t),this},e.prototype.add=function(t){for(var e=0,i=this.addHooks.length;e<i&&!this.addHooks[e](t,this.queue);e++);if(t instanceof o.Container)for(e=t.children.length-1;e>=0;e--)this.add(t.children[e]);return this},e.prototype.destroy=function(){this.ticking&&r.Ticker.system.remove(this.tick,this),this.ticking=!1,this.addHooks=null,this.uploadHooks=null,this.renderer=null,this.completes=null,this.queue=null,this.limiter=null,this.uploadHookHelper=null},e}();function k(t,i){return i instanceof e.BaseTexture&&(i._glTextures[t.CONTEXT_UID]||t.texture.bind(i),!0)}function g(t,e){if(!(e instanceof i.Graphics))return!1;var r=e.geometry;e.finishPoly(),r.updateBatches();for(var o=r.batches,n=0;n<o.length;n++){var s=o[n].style.texture;s&&k(t,s.baseTexture)}return r.batchable||t.geometry.bind(r,e._resolveDirectShader(t)),!0}function m(t,e){return t instanceof i.Graphics&&(e.push(t),!0)}var T=function(t){function e(e){var i=t.call(this,e)||this;return i.uploadHookHelper=i.renderer,i.registerFindHook(m),i.registerUploadHook(k),i.registerUploadHook(g),i}return function(t,e){function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}(e,t),e}(x),y=function(){function t(t){this.maxMilliseconds=t,this.frameStart=0}return t.prototype.beginFrame=function(){this.frameStart=Date.now()},t.prototype.allowedToUpload=function(){return Date.now()-this.frameStart<this.maxMilliseconds},t}();exports.BasePrepare=x,exports.CountLimiter=u,exports.Prepare=T,exports.TimeLimiter=y;
//# sourceMappingURL=prepare.min.js.map
